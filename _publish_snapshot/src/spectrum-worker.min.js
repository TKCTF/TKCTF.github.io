var TKCTF=(()=>{var u=2048,p=44100,h=u/2,y={LOW:{start:0,end:.1},MID_LOW:{start:.1,end:.3},MID:{start:.3,end:.6},MID_HIGH:{start:.6,end:.8},HIGH:{start:.8,end:1}},B=0,m=188,I=25,f=[],g=0,M=120,b=null,H=0;self.onmessage=function(e){let{type:t,data:n}=e.data;switch(t){case"init":v(n);break;case"spectrumData":D(n);break;case"config":w(n);break;case"stop":q();break}};function v(e){e&&(u=e.fftSize||2048,p=e.sampleRate||44100,h=u/2),self.postMessage({type:"initComplete",data:{fftSize:u,sampleRate:p,frequencyBins:h}})}function w(e){e.fftSize&&(u=e.fftSize),e.sampleRate&&(p=e.sampleRate),e.beatThreshold&&(m=e.beatThreshold),e.beatCooldown&&(I=e.beatCooldown),e.heavyBeatCooldown&&(M=e.heavyBeatCooldown)}function D(e){let t=Date.now();if(t-H<16)return;H=t;let n=C(e),r=S(e,t),a=k(n,t),o=R(e,n);self.postMessage({type:"processedSpectrumData",data:{bandEnergies:n,beat:r,heavyBeat:a,spectrumFeatures:o,timestamp:t}})}function C(e){let t={};for(let[n,r]of Object.entries(y)){let a=Math.floor(r.start*h),o=Math.floor(r.end*h),i=0,l=0;for(let c=a;c<o&&c<e.length;c++)i+=e[c],l++;t[n]=l>0?i/l:0}return t}function S(e,t){let a=Math.floor(1500/(p/2)*h),o=Math.floor(2250/(p/2)*h),i=0,l=0;for(let d=a;d<=o&&d<e.length;d++)i+=e[d],l++;let c=l>0?i/l:0,s=c>m&&t-B>I;return s&&(B=t),{detected:s,intensity:c/255,threshold:m/255,frequency:c}}function k(e,t){let n=e.MID_HIGH||0,r=e.HIGH||0,a=(n+r)/2,o=160,i=a>o;f.push({time:t,isActive:i,energy:a}),f=f.filter(s=>t-s.time<=20);let l=f.filter(s=>s.isActive),c=l.length>0&&t-g>M;return c&&(g=t),{detected:c,intensity:a/255,threshold:o/255,energy:a,recentCount:l.length}}function R(e,t){let n=e.reduce((s,d)=>s+d,0)/e.length,r=Math.max(...e),a=0,o=0;for(let s=0;s<e.length;s++)a+=s*e[s],o+=e[s];let i=o>0?a/o:0,l=0;for(let s=0;s<e.length;s++){let d=s-i;l+=d*d*e[s]}let c=o>0?Math.sqrt(l/o):0;return{totalEnergy:n/255,peak:r/255,spectralCentroid:i/h,spectralBandwidth:c/h,bandEnergies:{low:t.LOW/255,midLow:t.MID_LOW/255,mid:t.MID/255,midHigh:t.MID_HIGH/255,high:t.HIGH/255}}}function q(){f=[],b=null,self.postMessage({type:"workerStopped",data:{}})}self.onerror=function(e){self.postMessage({type:"error",data:{message:e.message,filename:e.filename,lineno:e.lineno}})};})();
